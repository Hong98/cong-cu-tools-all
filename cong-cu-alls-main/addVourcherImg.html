<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="C√¥ng c·ª• t·ª± ƒë·ªông h√≥a t·∫°o m√£ QR v√† ch√®n v√†o ·∫£nh voucher - X·ª≠ l√Ω h√†ng lo·∫°t, ti·∫øt ki·ªám th·ªùi gian, giao di·ªán hi·ªán ƒë·∫°i">
    <meta name="keywords" content="t·∫°o m√£ QR, QR code generator, th√™m QR v√†o voucher, t·ª± ƒë·ªông h√≥a QR, ch√®n QR code">
    <meta name="author" content="DVNT Tools">
    <meta property="og:title" content="C√¥ng C·ª• T·∫°o M√£ QR T·ª± ƒê·ªông - DVNT Tools">
    <meta property="og:description" content="Ph·∫ßn m·ªÅm t·ª± ƒë·ªông h√≥a qu√° tr√¨nh t·∫°o m√£ QR v√† th√™m v√†o ·∫£nh voucher">
    <meta property="og:type" content="website">
    <meta name="robots" content="index, follow">
    <title>C√¥ng C·ª• T·∫°o M√£ QR V√† Ch√®n V√†o Voucher | DVNT Tools</title>
    <!-- jQuery Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    
    <!-- QRCode.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/@keeex/qrcodejs-kx@1.0.2/qrcode.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./asset/css/style.css">
    
    <style>
        /* ==================== GLOBAL STYLES ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Modern Gradient Colors */
            --dvntAddIg-primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --dvntAddIg-accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --dvntAddIg-success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --dvntAddIg-dark-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            
            /* Solid Colors */
            --dvntAddIg-primary-color: #667eea;
            --dvntAddIg-secondary-color: #764ba2;
            --dvntAddIg-accent-color: #f093fb;
            --dvntAddIg-dark-bg: #0f172a;
            --dvntAddIg-light-bg: #ffffff;
            --dvntAddIg-glass-bg: rgba(255, 255, 255, 0.1);
            --dvntAddIg-glass-border: rgba(255, 255, 255, 0.2);
            --dvntAddIg-border-color: rgba(255, 255, 255, 0.1);
            
            /* Text Colors - FOR DARK THEME */
            --dvntAddIg-text-primary: #0f172a;
            --dvntAddIg-text-secondary: #0f172a;
            --dvntAddIg-text-white: #ffffff;
            --dvntAddIg-text-muted: rgba(255, 255, 255, 0.5);
            
            /* Status Colors */
            --dvntAddIg-success-color: #10b981;
            --dvntAddIg-error-color: #ef4444;
            --dvntAddIg-warning-color: #f59e0b;
            --dvntAddIg-info-color: #3b82f6;
            
            /* Shadows & Effects */
            --dvntAddIg-shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --dvntAddIg-shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
            --dvntAddIg-shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.12);
            --dvntAddIg-shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.15);
            --dvntAddIg-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --dvntAddIg-glow: 0 0 30px rgba(102, 126, 234, 0.4);
            
            /* Border Radius */
            --dvntAddIg-radius-sm: 8px;
            --dvntAddIg-radius-md: 12px;
            --dvntAddIg-radius-lg: 16px;
            --dvntAddIg-radius-xl: 24px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            background-attachment: fixed;
            min-height: 100vh;
            line-height: 1.6;
            color: var(--dvntAddIg-text-primary);
            position: relative;
            overflow-x: hidden;
            padding-top: 100px !important;
        }

        /* Animated Background Particles */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(240, 147, 251, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .dvntAddIg__upload-hint,
        .dvntAddIg__section-title, 
        [style*="color: var(--dvntAddIg-text-secondary)"] {
            color: var( --dvntAddIg-text-secondary) !important;
        }
        /* .dvntAddIg__section {
            border-radius: var(--dvntAddIg-radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
        } */
         .dvntAddIg__input, .dvntAddIg__select, .dvntAddIg__textarea{
    
            border-color: var(--dvntAddIg-primary-color);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        border: 2px solid var(--dvntAddIg-border-color) !important;
         }
        /* ==================== HEADER ==================== */
        .dvntAddIg__header {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 0;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .dvntAddIg__header:hover {
            box-shadow: 0 8px 40px rgba(102, 126, 234, 0.2);
        }

        .dvntAddIg__header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dvntAddIg__logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dvntAddIg__logo-icon {
            width: 48px;
            height: 48px;
            background: var(--dvntAddIg-primary-gradient);
            border-radius: var(--dvntAddIg-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.5rem;
            box-shadow: var(--dvntAddIg-shadow-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dvntAddIg__logo-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            transition: all 0.5s ease;
        }

        .dvntAddIg__logo-icon:hover::before {
            left: 100%;
        }

        .dvntAddIg__logo-icon:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .dvntAddIg__logo-text {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
        }

        .dvntAddIg__nav {
            display: flex;
            gap: 2rem;
        }

        .dvntAddIg__nav-link {
            text-decoration: none;
            color: var(--dvntAddIg-text-white);
            font-weight: 500;
            transition: color 0.3s ease;
            position: relative;
        }

        .dvntAddIg__nav-link:hover {
            color: var(--dvntAddIg-primary-color);
        }

        .dvntAddIg__nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--dvntAddIg-primary-color);
            transition: width 0.3s ease;
        }

        .dvntAddIg__nav-link:hover::after {
            width: 100%;
        }

        /* ==================== MAIN CONTAINER ==================== */
        .dvntAddIg__container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .dvntAddIg__hero {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }

        .dvntAddIg__hero-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dvntAddIg__hero-subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 700px;
            margin: 0 auto;
        }

        /* ==================== MAIN WORKSPACE ==================== */
        .dvntAddIg__workspace {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: var(--dvntAddIg-shadow-lg);
            margin-bottom: 2rem;
        }

        .dvntAddIg__tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--dvntAddIg-border-color);
            flex-wrap: wrap;
        }

        .dvntAddIg__tab {
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: var(--dvntAddIg-text-secondary);
            transition: all 0.3s ease;
            position: relative;
        }

        .dvntAddIg__tab--active {
            color: var(--dvntAddIg-primary-color);
        }

        .dvntAddIg__tab--active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--dvntAddIg-primary-color);
        }

        .dvntAddIg__tab:hover {
            color: var(--dvntAddIg-primary-color);
        }

        .dvntAddIg__tab-content {
            display: none;
        }

        .dvntAddIg__tab-content--active {
            display: block;
            animation: dvntAddIg-fadeIn 0.5s ease;
        }

        /* ==================== UPLOAD SECTIONS ==================== */
        .dvntAddIg__section {
            margin-bottom: 2.5rem;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--dvntAddIg-radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s ease;
            animation: slideUp 0.6s ease-out;
        }

        .dvntAddIg__section:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.1);
        }

        .dvntAddIg__section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .dvntAddIg__section-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--dvntAddIg-primary-gradient);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .dvntAddIg__upload-area {
            border: 3px dashed rgba(102, 126, 234, 0.4);
            border-radius: var(--dvntAddIg-radius-lg);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(102, 126, 234, 0.05);
            position: relative;
            overflow: hidden;
        }

        .dvntAddIg__upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .dvntAddIg__upload-area:hover::before {
            left: 100%;
        }

        .dvntAddIg__upload-area:hover {
            border-color: rgba(102, 126, 234, 0.8);
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-5px);
            box-shadow: 
                0 15px 40px rgba(102, 126, 234, 0.2),
                inset 0 0 0 1px rgba(102, 126, 234, 0.3);
        }

        .dvntAddIg__upload-area--dragging {
            border-color: var(--dvntAddIg-accent-color);
            background: rgba(240, 147, 251, 0.15);
            transform: scale(1.02);
            box-shadow: 0 20px 50px rgba(240, 147, 251, 0.3);
            animation: pulse 1s infinite;
        }

        .dvntAddIg__upload-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(102, 126, 234, 0.3));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .dvntAddIg__upload-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #0f172a;
            margin-bottom: 0.5rem;
        }

        .dvntAddIg__upload-hint {
            font-size: 0.925rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .dvntAddIg__file-input {
            display: none;
        }

        /* ==================== FORM ELEMENTS ==================== */
        .dvntAddIg__form-group {
            margin-bottom: 1.5rem;
        }

        .dvntAddIg__label {
            display: block;
            font-weight: 600;
            color: var(--dvntAddIg-text-primary);
            margin-bottom: 0.5rem;
        }

        .dvntAddIg__input,
        .dvntAddIg__select,
        .dvntAddIg__textarea {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--dvntAddIg-border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .dvntAddIg__input:focus,
        .dvntAddIg__select:focus,
        .dvntAddIg__textarea:focus {
            outline: none;
            border-color: var(--dvntAddIg-primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .dvntAddIg__textarea {
            resize: vertical;
            min-height: 100px;
        }

        .dvntAddIg__controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* ==================== BUTTONS ==================== */
        .dvntAddIg__button {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .dvntAddIg__button--primary {
            background: linear-gradient(135deg, var(--dvntAddIg-primary-color), var(--dvntAddIg-secondary-color));
            color: white;
            box-shadow: var(--dvntAddIg-shadow);
        }

        .dvntAddIg__button--primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--dvntAddIg-shadow-lg);
        }

        .dvntAddIg__button--secondary {
            background: white;
            color: var(--dvntAddIg-primary-color);
            border: 2px solid var(--dvntAddIg-primary-color);
        }

        .dvntAddIg__button--secondary:hover {
            background: var(--dvntAddIg-primary-color);
            color: white;
        }

        .dvntAddIg__button--success {
            background: var(--dvntAddIg-success-color);
            color: white;
        }

        .dvntAddIg__button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dvntAddIg__button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        /* ==================== PREVIEW SECTION ==================== */
        .dvntAddIg__preview {
            background: var(--dvntAddIg-light-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }

        .dvntAddIg__preview-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--dvntAddIg-text-primary);
        }

        .dvntAddIg__preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .dvntAddIg__preview-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--dvntAddIg-shadow);
            transition: transform 0.3s ease;
        }

        .dvntAddIg__preview-item:hover {
            transform: translateY(-5px);
        }

        .dvntAddIg__preview-image {
            width: 100%;
            height: 200px;
            object-fit: contain;
            border-radius: 4px;
            background: var(--dvntAddIg-light-bg);
        }

        .dvntAddIg__preview-name {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--dvntAddIg-text-secondary);
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ==================== INTERACTIVE CANVAS ==================== */
        .dvntAddIg__canvas-container {
            position: relative;
            display: inline-block;
            margin: 1rem auto;
            border: 2px solid var(--dvntAddIg-border-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--dvntAddIg-shadow);
        }

        .dvntAddIg__canvas {
            display: block;
            max-width: 100%;
            height: auto;
            cursor: move;
        }

        .dvntAddIg__qr-overlay {
            position: absolute;
            border: 2px dashed var(--dvntAddIg-primary-color);
            cursor: move;
            background: rgba(99, 102, 241, 0.1);
            box-sizing: border-box;
        }

        .dvntAddIg__qr-overlay:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--dvntAddIg-secondary-color);
        }

        .dvntAddIg__qr-overlay::after {
            content: '‚äï K√©o ƒë·ªÉ di chuy·ªÉn';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .dvntAddIg__qr-overlay:hover::after {
            opacity: 1;
        }

        .dvntAddIg__controls-hint {
            text-align: center;
            color: var(--dvntAddIg-text-secondary);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* ==================== RANGE SLIDER STYLES ==================== */
        .dvntAddIg__range-container {
            position: relative;
        }

        .dvntAddIg__range-value {
            position: absolute;
            right: 0;
            top: 0;
            background: var(--dvntAddIg-primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.875rem;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
        }

        .dvntAddIg__input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--dvntAddIg-border-color);
            border-radius: 4px;
            outline: none;
            margin-top: 0.5rem;
        }

        .dvntAddIg__input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--dvntAddIg-primary-color), var(--dvntAddIg-secondary-color));
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .dvntAddIg__input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .dvntAddIg__input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--dvntAddIg-primary-color), var(--dvntAddIg-secondary-color));
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease;
        }

        .dvntAddIg__input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.2);
        }

        .dvntAddIg__input[type="range"]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dvntAddIg__input[type="range"]:disabled::-webkit-slider-thumb {
            cursor: not-allowed;
            background: var(--dvntAddIg-text-secondary);
        }

        .dvntAddIg__input[type="range"]:disabled::-moz-range-thumb {
            cursor: not-allowed;
            background: var(--dvntAddIg-text-secondary);
        }

        .dvntAddIg__input[type="range"]:focus {
            outline: none;
        }

        .dvntAddIg__input[type="range"]::-webkit-slider-runnable-track {
            background: linear-gradient(to right, 
                var(--dvntAddIg-primary-color) 0%, 
                var(--dvntAddIg-primary-color) var(--range-progress, 0%), 
                var(--dvntAddIg-border-color) var(--range-progress, 0%), 
                var(--dvntAddIg-border-color) 100%);
            border-radius: 4px;
            height: 8px;
        }

        .dvntAddIg__input[type="range"]::-moz-range-track {
            background: var(--dvntAddIg-border-color);
            border-radius: 4px;
            height: 8px;
        }

        .dvntAddIg__input[type="range"]::-moz-range-progress {
            background: var(--dvntAddIg-primary-color);
            border-radius: 4px;
            height: 8px;
        }

        /* ==================== PROGRESS BAR ==================== */
        .dvntAddIg__progress {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1.5rem 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .dvntAddIg__progress-bar {
            height: 100%;
            background: var(--dvntAddIg-success-gradient);
            border-radius: 4px;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(79, 172, 254, 0.5);
            position: relative;
            overflow: hidden;
        }

        .dvntAddIg__progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* ==================== FEATURES GRID ==================== */
        .dvntAddIg__features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 3rem;
        }

        .dvntAddIg__feature-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: var(--dvntAddIg-radius-lg);
            box-shadow: var(--dvntAddIg-shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .dvntAddIg__feature-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.25);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .dvntAddIg__feature-icon {
            width: 60px;
            height: 60px;
            background: var(--dvntAddIg-primary-gradient);
            border-radius: var(--dvntAddIg-radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            margin-bottom: 1rem;
            box-shadow: var(--dvntAddIg-shadow-lg);
        }

        .dvntAddIg__feature-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: white;
        }

        .dvntAddIg__feature-description {
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
        }

        /* ==================== FOOTER ==================== */
        .dvntAddIg__footer {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            padding: 2rem 0;
            text-align: center;
            margin-top: 4rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dvntAddIg__footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .dvntAddIg__footer-content p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.95rem;
        }

        /* ==================== UTILITY CLASSES ==================== */
        .dvntAddIg__card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: var(--dvntAddIg-radius-lg);
            padding: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .dvntAddIg__card:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
        }

        .dvntAddIg__badge {
            display: inline-flex;
            align-items: center;
            padding: 0.35rem 0.85rem;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: 600;
            background: var(--dvntAddIg-primary-gradient);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .dvntAddIg__divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            margin: 2rem 0;
        }

        .dvntAddIg__text-gradient {
            background: var(--dvntAddIg-primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ==================== SCROLL BAR ==================== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dvntAddIg-primary-gradient);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--dvntAddIg-accent-gradient);
        }

        /* ==================== SELECTION ==================== */
        ::selection {
            background: rgba(102, 126, 234, 0.3);
            color: white;
        }

        ::-moz-selection {
            background: rgba(102, 126, 234, 0.3);
            color: white;
        }

        /* ==================== ANIMATIONS ==================== */
        @keyframes dvntAddIg-fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes dvntAddIg-spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            }
        }

        .dvntAddIg__loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: dvntAddIg-spin 0.8s linear infinite;
        }

        /* Loading Dots Animation */
        .dvntAddIg__loading-dots {
            display: inline-flex;
            gap: 0.5rem;
        }

        .dvntAddIg__loading-dots span {
            width: 8px;
            height: 8px;
            background: var(--dvntAddIg-primary-gradient);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .dvntAddIg__loading-dots span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .dvntAddIg__loading-dots span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        /* ==================== RESPONSIVE DESIGN ==================== */
        @media screen and (max-width: 1024px) {
            .dvntAddIg__container {
                padding: 0 1.5rem;
            }

            .dvntAddIg__workspace {
                padding: 2rem;
            }

            .dvntAddIg__hero-title {
                font-size: 2rem;
            }
        }

        @media screen and (max-width: 768px) {
            .dvntAddIg__header-container {
                flex-direction: column;
                gap: 1rem;
            }

            .dvntAddIg__nav {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }

            .dvntAddIg__hero-title {
                font-size: 1.75rem;
            }

            .dvntAddIg__hero-subtitle {
                font-size: 1rem;
            }

            .dvntAddIg__tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }

            .dvntAddIg__tab {
                padding: 0.75rem 1.5rem;
                white-space: nowrap;
            }

            .dvntAddIg__workspace {
                padding: 1.5rem;
            }

            .dvntAddIg__upload-area {
                padding: 2rem 1rem;
            }

            .dvntAddIg__controls {
                grid-template-columns: 1fr;
            }

            .dvntAddIg__button-group {
                flex-direction: column;
            }

            .dvntAddIg__button {
                width: 100%;
            }

            .dvntAddIg__preview-grid {
                grid-template-columns: 1fr;
            }
        }

        @media screen and (max-width: 480px) {
            .dvntAddIg__container {
                padding: 0 1rem;
                margin: 1rem auto;
            }

            .dvntAddIg__hero {
                margin-bottom: 2rem;
            }

            .dvntAddIg__hero-title {
                font-size: 1.5rem;
            }

            .dvntAddIg__section-title {
                font-size: 1.1rem;
            }

            .dvntAddIg__upload-area {
                padding: 1.5rem 0.75rem;
            }

            .dvntAddIg__upload-icon {
                font-size: 2rem;
            }
        }

        /* ==================== OVERRIDE INLINE STYLES ==================== */
        /* Ensure all text is visible on dark background */
        [style*="color: var(--dvntAddIg-text-secondary)"] {
            color: var( --dvntAddIg-text-secondary) !important;
        }

        [style*="color: var(--dvntAddIg-text-primary)"] {
            color: #ffffff !important;
        }

        #batchSizeValue,
        #globalXValue,
        #globalYValue {
            color: #667eea !important;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="doitenhinhanhsticky__header" id="doitenhinhanhsticky__header">
        <!-- render header -->
    </header>
    <!-- ƒêo·∫°n scrip render header -->
    <script>
        fetch('./templates/header.html')
            .then(response => response.text())
            .then(data => {
                document.querySelector("#doitenhinhanhsticky__header").innerHTML = data;
            })
            .catch(error => console.error('L·ªói:', error));
    </script>

    <!-- MAIN CONTAINER -->
    <main class="dvntAddIg__container">
        <!-- HERO SECTION -->
        <section class="dvntAddIg__hero">
            <h2 class="dvntAddIg__hero-title">C√¥ng C·ª• th√™m h√†ng lo·∫°t QR v√†o Voucher </h2>
            <p class="dvntAddIg__hero-subtitle">T·ª± ƒë·ªông h√≥a qu√° tr√¨nh t·∫°o m√£ QR v√† ch√®n v√†o ·∫£nh voucher - Nhanh ch√≥ng, chuy√™n nghi·ªáp, hi·ªáu qu·∫£</p>
        </section>

        <!-- MAIN WORKSPACE -->
        <div class="dvntAddIg__workspace">
            <!-- TABS -->
            <div class="dvntAddIg__tabs">
                <button class="dvntAddIg__tab dvntAddIg__tab--active" data-tab="batch">H√†ng Lo·∫°t</button>
                <button class="dvntAddIg__tab" data-tab="settings">C√†i ƒê·∫∑t</button>
            </div>

            <!-- TAB CONTENT: BATCH MODE -->
            <div class="dvntAddIg__tab-content dvntAddIg__tab-content--active" data-content="batch">
                <div class="dvntAddIg__section">
                    <h3 class="dvntAddIg__section-title">T·∫£i L√™n Voucher (1 ho·∫∑c Nhi·ªÅu File)</h3>
                    <div class="dvntAddIg__upload-area" id="batchVoucherUpload">
                        <div class="dvntAddIg__upload-icon">üìÅ</div>
                        <p class="dvntAddIg__upload-text">Ch·ªçn 1 ho·∫∑c nhi·ªÅu ·∫£nh voucher</p>
                        <p class="dvntAddIg__upload-hint">H·ªó tr·ª£ ch·ªçn t·ª´ 1 ƒë·∫øn nhi·ªÅu file c√πng l√∫c</p>
                        <input type="file" class="dvntAddIg__file-input" id="batchVoucherInput" accept="image/*" multiple>
                    </div>
                    <div id="voucherCount" style="text-align: center; margin-top: 0.5rem; color: var(--dvntAddIg-text-secondary); font-weight: 600;"></div>
                </div>

                <div class="dvntAddIg__section">
                    <h3 class="dvntAddIg__section-title">Ch·ªçn M√£ QR</h3>
                    
                    <!-- QR Selection Mode -->
                    <div class="dvntAddIg__controls" style="margin-bottom: 1rem;">
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label">Ch·∫ø ƒë·ªô QR</label>
                            <select class="dvntAddIg__select" id="qrMode">
                                <option value="single">D√πng 1 QR cho t·∫•t c·∫£ voucher</option>
                                <option value="multiple">M·ªói voucher 1 QR ri√™ng</option>
                                <option value="generate">T·∫°o QR t·ª± ƒë·ªông</option>
                                <option value="list">D√πng 1 voucher cho nhi·ªÅu QR</option>
                            </select>
                        </div>
                    </div>

                    <!-- Upload QR -->
                    <div id="qrUploadSection">
                        <div class="dvntAddIg__upload-area" id="batchQrUpload">
                            <div class="dvntAddIg__upload-icon">üî≤</div>
                            <p class="dvntAddIg__upload-text" id="qrUploadText">Ch·ªçn 1 m√£ QR chung</p>
                            <p class="dvntAddIg__upload-hint" id="qrUploadHint">S·∫Ω s·ª≠ d·ª•ng c√πng QR n√†y cho t·∫•t c·∫£ voucher</p>
                            <input type="file" class="dvntAddIg__file-input" id="batchQrInput" accept="image/*">
                        </div>
                        <div id="qrCount" style="text-align: center; margin-top: 0.5rem; color: var(--dvntAddIg-text-secondary); font-weight: 600;"></div>
                    </div>

                    <!-- Upload Voucher for List Mode -->
                    <div id="voucherListUploadSection" style="display: none;">
                        <div class="dvntAddIg__upload-area" id="voucherListUpload">
                            <div class="dvntAddIg__upload-icon">üìÑ</div>
                            <p class="dvntAddIg__upload-text" id="voucherListText">Ch·ªçn 1 ·∫£nh voucher</p>
                            <p class="dvntAddIg__upload-hint" id="voucherListHint">S·∫Ω √°p d·ª•ng t·ª´ng QR kh√°c nhau l√™n voucher n√†y</p>
                            <input type="file" class="dvntAddIg__file-input" id="voucherListInput" accept="image/*">
                        </div>
                        <div id="voucherListCount" style="text-align: center; margin-top: 0.5rem; color: var(--dvntAddIg-text-secondary); font-weight: 600;"></div>
                    </div>

                    <!-- Generate QR Section -->
                    <div id="qrGenerateSection" style="display: none;">
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label">M·∫´u URL (s·ª≠ d·ª•ng {index} cho s·ªë th·ª© t·ª±)</label>
                            <input type="text" class="dvntAddIg__input" id="qrUrlPattern" placeholder="https://example.com/voucher/{index}">
                        </div>
                        <p class="dvntAddIg__upload-hint">V√≠ d·ª•: https://example.com/voucher/{index} ‚Üí voucher/1, voucher/2, ...</p>
                    </div>
                </div>

                <div class="dvntAddIg__section">
                    <h3 class="dvntAddIg__section-title">V·ªã Tr√≠ & K√≠ch Th∆∞·ªõc QR</h3>
                    <div class="dvntAddIg__controls">
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="batchPosition">V·ªã tr√≠ m·∫∑c ƒë·ªãnh</label>
                            <select class="dvntAddIg__select" id="batchPosition">
                                <option value="bottom-right">G√≥c d∆∞·ªõi ph·∫£i</option>
                                <option value="top-right">G√≥c tr√™n ph·∫£i</option>
                                <option value="bottom-left">G√≥c d∆∞·ªõi tr√°i</option>
                                <option value="top-left">G√≥c tr√™n tr√°i</option>
                                <option value="center">Gi·ªØa</option>
                            </select>
                        </div>
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="batchSize">
                                K√≠ch th∆∞·ªõc 
                                <span id="batchSizeValue" style="color: var(--dvntAddIg-primary-color); font-weight: 700;">15%</span>
                            </label>
                            <input type="range" class="dvntAddIg__input" id="batchSize" value="15" min="5" max="50" step="1">
                        </div>
                    </div>
                    <p class="dvntAddIg__controls-hint">üí° Thay ƒë·ªïi t·ª± ƒë·ªông c·∫≠p nh·∫≠t preview. Sau ƒë√≥ b·∫°n c√≥ th·ªÉ k√©o th·∫£ ƒë·ªÉ ƒëi·ªÅu ch·ªânh chi ti·∫øt</p>
                </div>

                <!-- Global Position Controls -->
                <div class="dvntAddIg__section" id="globalPositionControls" style="display: none;">
                    <h3 class="dvntAddIg__section-title">üéØ ƒêi·ªÅu Ch·ªânh ƒê·ªìng Th·ªùi T·∫•t C·∫£ Voucher</h3>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem;">
                        <div class="dvntAddIg__controls">
                            <div class="dvntAddIg__form-group">
                                <label class="dvntAddIg__label" style="color: white;">
                                    ‚ÜîÔ∏è V·ªã tr√≠ ngang cho t·∫•t c·∫£ 
                                    <span id="globalXValue" style="color: #fbbf24; font-weight: 700;">0px</span>
                                </label>
                                <input type="range" class="dvntAddIg__input" id="globalSliderX" value="0" min="0" max="2000" step="1">
                            </div>
                            <div class="dvntAddIg__form-group">
                                <label class="dvntAddIg__label" style="color: white;">
                                    ‚ÜïÔ∏è V·ªã tr√≠ d·ªçc cho t·∫•t c·∫£ 
                                    <span id="globalYValue" style="color: #fbbf24; font-weight: 700;">0px</span>
                                </label>
                                <input type="range" class="dvntAddIg__input" id="globalSliderY" value="0" min="0" max="2000" step="1">
                            </div>
                        </div>
                        <p style="color: white; font-size: 0.85rem; text-align: center; margin-top: 0.5rem; opacity: 0.9;">
                            ‚ö° √Åp d·ª•ng c√πng v·ªã tr√≠ cho t·∫•t c·∫£ voucher
                        </p>
                    </div>
                </div>

                <!-- Interactive Preview Section -->
                <div class="dvntAddIg__section" id="interactivePreviewSection" style="display: none;">
                    <h3 class="dvntAddIg__section-title">ƒêi·ªÅu Ch·ªânh V·ªã Tr√≠ QR (K√©o th·∫£ ho·∫∑c d√πng thanh tr∆∞·ª£t ri√™ng)</h3>
                    <div id="canvasGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 1rem;">
                        <!-- Canvas items will be inserted here -->
                    </div>
                </div>

                <div class="dvntAddIg__progress" style="display: none;" id="batchProgress">
                    <div class="dvntAddIg__progress-bar" id="batchProgressBar"></div>
                </div>

                <div class="dvntAddIg__button-group">
                    <button class="dvntAddIg__button dvntAddIg__button--primary" id="batchProcessBtn">
                        <span>Xem Tr∆∞·ªõc & ƒêi·ªÅu Ch·ªânh</span>
                    </button>
                    <button class="dvntAddIg__button dvntAddIg__button--success" id="downloadAllBtn" style="display: none;">
                        <span>‚úì T·∫£i T·∫•t C·∫£ (Ri√™ng l·∫ª)</span>
                    </button>
                    <button class="dvntAddIg__button dvntAddIg__button--success" id="downloadZipBtn" style="display: none; background: linear-gradient(135deg, #10b981, #059669);">
                        <span>üì¶ T·∫£i Xu·ªëng ZIP</span>
                    </button>
                    <button class="dvntAddIg__button dvntAddIg__button--secondary" id="resetBatchBtn" style="display: none;">
                        <span>‚Ü∫ L√†m L·∫°i</span>
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT: SETTINGS -->
            <div class="dvntAddIg__tab-content" data-content="settings">
                <div class="dvntAddIg__section">
                    <h3 class="dvntAddIg__section-title">C√†i ƒê·∫∑t Xu·∫•t File</h3>
                    <p class="dvntAddIg__controls-hint" style="margin-bottom: 1rem;">üí° Thay ƒë·ªïi s·∫Ω t·ª± ƒë·ªông √°p d·ª•ng khi t·∫£i xu·ªëng</p>
                    <div class="dvntAddIg__controls">
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="outputFormat">ƒê·ªãnh d·∫°ng xu·∫•t</label>
                            <select class="dvntAddIg__select" id="outputFormat">
                                <option value="png">PNG</option>
                                <option value="jpg">JPG</option>
                                <option value="jpeg">JPEG</option>
                            </select>
                        </div>
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="outputQuality">
                                Ch·∫•t l∆∞·ª£ng 
                                <span id="outputQualityValue" style="color: var(--dvntAddIg-primary-color); font-weight: 700;">100%</span>
                            </label>
                            <input type="range" class="dvntAddIg__input" id="outputQuality" value="100" min="1" max="100" step="1">
                        </div>
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="filePrefix">Ti·ªÅn t·ªë t√™n file</label>
                            <input type="text" class="dvntAddIg__input" id="filePrefix" placeholder="voucher_qr_" value="voucher_qr_">
                        </div>
                    </div>
                </div>

                <div class="dvntAddIg__section">
                    <h3 class="dvntAddIg__section-title">Ch·ªânh S·ª≠a ·∫¢nh</h3>
                    <p class="dvntAddIg__controls-hint" style="margin-bottom: 1rem;">üí° Thay ƒë·ªïi s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t preview (n·∫øu c√≥)</p>
                    <div class="dvntAddIg__controls">
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="brightness">
                                ƒê·ªô s√°ng 
                                <span id="brightnessValue" style="color: var(--dvntAddIg-primary-color); font-weight: 700;">100%</span>
                            </label>
                            <input type="range" class="dvntAddIg__input" id="brightness" min="0" max="200" value="100" step="1">
                        </div>
                        <div class="dvntAddIg__form-group">
                            <label class="dvntAddIg__label" for="contrast">
                                ƒê·ªô t∆∞∆°ng ph·∫£n 
                                <span id="contrastValue" style="color: var(--dvntAddIg-primary-color); font-weight: 700;">100%</span>
                            </label>
                            <input type="range" class="dvntAddIg__input" id="contrast" min="0" max="200" value="100" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- PREVIEW SECTION -->
            <div class="dvntAddIg__preview" id="previewSection" style="display: none;">
                <h4 class="dvntAddIg__preview-title">Xem Tr∆∞·ªõc K·∫øt Qu·∫£</h4>
                <div class="dvntAddIg__preview-grid" id="previewGrid"></div>
            </div>
        </div>

        <!-- FEATURES SECTION -->
        <section class="dvntAddIg__features" id="features">
            <article class="dvntAddIg__feature-card">
                <div class="dvntAddIg__feature-icon">‚ö°</div>
                <h3 class="dvntAddIg__feature-title">X·ª≠ L√Ω Nhanh</h3>
                <p class="dvntAddIg__feature-description">T·ª± ƒë·ªông h√≥a ho√†n to√†n, x·ª≠ l√Ω h√†ng lo·∫°t h√†ng ngh√¨n voucher ch·ªâ trong v√†i ph√∫t</p>
            </article>
            <article class="dvntAddIg__feature-card">
                <div class="dvntAddIg__feature-icon">üé®</div>
                <h3 class="dvntAddIg__feature-title">T√πy Ch·ªânh Linh Ho·∫°t</h3>
                <p class="dvntAddIg__feature-description">ƒêi·ªÅu ch·ªânh v·ªã tr√≠, k√≠ch th∆∞·ªõc, m√†u s·∫Øc m√£ QR theo √Ω mu·ªën</p>
            </article>
            <article class="dvntAddIg__feature-card">
                <div class="dvntAddIg__feature-icon">üì±</div>
                <h3 class="dvntAddIg__feature-title">Responsive Design</h3>
                <p class="dvntAddIg__feature-description">Ho·∫°t ƒë·ªông m∆∞·ª£t m√† tr√™n m·ªçi thi·∫øt b·ªã: m√°y t√≠nh, tablet, ƒëi·ªán tho·∫°i</p>
            </article>
        </section>
    </main>

    <!-- FOOTER -->
    <footer class="dvnt-footer" id="dvnt-footer"></footer>
        <script>
        fetch('./templates/footer.html')
            .then(response => response.text())
            .then(data => {
                document.querySelector("#dvnt-footer").innerHTML = data;
            })
            .catch(error => console.error('L·ªói:', error));
    </script>

    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    
    <!-- JSZip Library for creating ZIP files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <script>
        // ==================== CONSTANTS ====================
        const CONSTANTS = {
            MAX_CANVAS_WIDTH: 500,
            INITIAL_PREVIEW_LIMIT: 10,
            LAG_WARNING_THRESHOLD: 50,
            LARGE_BATCH_THRESHOLD: 100,
            LARGE_BATCH_SIZE: 20,
            SMALL_BATCH_SIZE: 10,
            LARGE_BATCH_DELAY: 50,
            SMALL_BATCH_DELAY: 100,
            LARGE_FILE_DELAY: 20,
            SMALL_FILE_DELAY: 50,
            DEBOUNCE_DELAY: 30,
            QR_SIZE: 512,
            DEFAULT_QUALITY: 100,
            DEFAULT_BRIGHTNESS: 100,
            DEFAULT_CONTRAST: 100,
        };

        // ==================== UTILITY FUNCTIONS ====================
        const dvntAddIg = {
            processedImages: [],
            batchVouchers: [],
            batchQRs: [],
            canvasItems: [],
            qrPositions: [], // Store QR positions for each voucher
            eventListeners: [], // Track event listeners for cleanup

            // Tab switching
            initTabs() {
                const tabs = document.querySelectorAll('.dvntAddIg__tab');
                const contents = document.querySelectorAll('.dvntAddIg__tab-content');

                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        const targetTab = tab.dataset.tab;
                        
                        tabs.forEach(t => t.classList.remove('dvntAddIg__tab--active'));
                        contents.forEach(c => c.classList.remove('dvntAddIg__tab-content--active'));
                        
                        tab.classList.add('dvntAddIg__tab--active');
                        document.querySelector(`[data-content="${targetTab}"]`).classList.add('dvntAddIg__tab-content--active');
                    });
                });
            },

            // QR Mode handler
            initQRModeHandler() {
                const qrModeSelect = document.getElementById('qrMode');
                const qrUploadSection = document.getElementById('qrUploadSection');
                const qrGenerateSection = document.getElementById('qrGenerateSection');
                const voucherUploadSection = document.querySelector('#batchVoucherUpload').parentElement;
                const voucherListUploadSection = document.getElementById('voucherListUploadSection');
                const qrInput = document.getElementById('batchQrInput');
                const voucherInput = document.getElementById('batchVoucherInput');
                const qrUploadText = document.getElementById('qrUploadText');
                const qrUploadHint = document.getElementById('qrUploadHint');

                if (qrModeSelect) {
                    qrModeSelect.addEventListener('change', (e) => {
                        const mode = e.target.value;
                        
                        if (mode === 'generate') {
                            qrUploadSection.style.display = 'none';
                            qrGenerateSection.style.display = 'block';
                            voucherUploadSection.style.display = 'block';
                            voucherListUploadSection.style.display = 'none';
                            voucherInput.removeAttribute('multiple');
                        } else if (mode === 'list') {
                            // Mode: 1 voucher + nhi·ªÅu QR
                            qrUploadSection.style.display = 'block';
                            qrGenerateSection.style.display = 'none';
                            voucherUploadSection.style.display = 'none';
                            voucherListUploadSection.style.display = 'block';
                            
                            qrInput.setAttribute('multiple', 'multiple');
                            qrUploadText.textContent = 'Ch·ªçn nhi·ªÅu m√£ QR';
                            qrUploadHint.textContent = 'M·ªói QR s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng l√™n c√πng 1 voucher';
                        } else {
                            qrUploadSection.style.display = 'block';
                            qrGenerateSection.style.display = 'none';
                            voucherUploadSection.style.display = 'block';
                            voucherListUploadSection.style.display = 'none';
                            voucherInput.setAttribute('multiple', 'multiple');
                            
                            if (mode === 'single') {
                                qrInput.removeAttribute('multiple');
                                qrUploadText.textContent = 'Ch·ªçn 1 m√£ QR chung';
                                qrUploadHint.textContent = 'S·∫Ω s·ª≠ d·ª•ng c√πng QR n√†y cho t·∫•t c·∫£ voucher';
                            } else if (mode === 'multiple') {
                                qrInput.setAttribute('multiple', 'multiple');
                                qrUploadText.textContent = 'Ch·ªçn nhi·ªÅu m√£ QR';
                                qrUploadHint.textContent = 'S·ªë l∆∞·ª£ng QR ph·∫£i b·∫±ng s·ªë voucher';
                            }
                        }
                    });
                }
            },

            // Update file counts
            updateFileCounts() {
                const voucherInput = document.getElementById('batchVoucherInput');
                const qrInput = document.getElementById('batchQrInput');
                const voucherListInput = document.getElementById('voucherListInput');
                const voucherCount = document.getElementById('voucherCount');
                const qrCount = document.getElementById('qrCount');
                const voucherListCount = document.getElementById('voucherListCount');
                const qrMode = document.getElementById('qrMode').value;

                if (qrMode === 'list') {
                    // List mode: 1 voucher + nhi·ªÅu QR
                    if (voucherListInput && voucherListInput.files.length > 0) {
                        voucherListCount.textContent = `‚úì ƒê√£ ch·ªçn 1 voucher`;
                        voucherListCount.style.color = 'var(--dvntAddIg-success-color)';
                    }
                    
                    if (qrInput.files.length > 0) {
                        qrCount.textContent = `‚úì ƒê√£ ch·ªçn ${qrInput.files.length} m√£ QR (s·∫Ω t·∫°o ${qrInput.files.length} voucher)`;
                        qrCount.style.color = 'var(--dvntAddIg-success-color)';
                    }
                } else {
                    // Normal mode
                    if (voucherInput.files.length > 0) {
                        voucherCount.textContent = `‚úì ƒê√£ ch·ªçn ${voucherInput.files.length} voucher`;
                        voucherCount.style.color = 'var(--dvntAddIg-success-color)';
                    }

                    if (qrInput.files.length > 0) {
                        qrCount.textContent = `‚úì ƒê√£ ch·ªçn ${qrInput.files.length} m√£ QR`;
                        qrCount.style.color = 'var(--dvntAddIg-success-color)';
                    }
                }
            },

            // File upload handling
            initUploadAreas() {
                const uploadAreas = [
                    { area: 'batchVoucherUpload', input: 'batchVoucherInput' },
                    { area: 'batchQrUpload', input: 'batchQrInput' },
                    { area: 'voucherListUpload', input: 'voucherListInput' }
                ];

                uploadAreas.forEach(({ area, input }) => {
                    const uploadArea = document.getElementById(area);
                    const fileInput = document.getElementById(input);

                    if (!uploadArea || !fileInput) return;

                    uploadArea.addEventListener('click', () => fileInput.click());

                    uploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        uploadArea.classList.add('dvntAddIg__upload-area--dragging');
                    });

                    uploadArea.addEventListener('dragleave', () => {
                        uploadArea.classList.remove('dvntAddIg__upload-area--dragging');
                    });

                    uploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        uploadArea.classList.remove('dvntAddIg__upload-area--dragging');
                        fileInput.files = e.dataTransfer.files;
                        this.handleFileSelect(fileInput);
                    });

                    fileInput.addEventListener('change', () => this.handleFileSelect(fileInput));
                });
            },

            handleFileSelect(input) {
                const files = input.files;
                if (files.length > 0) {
                    console.log(`ƒê√£ ch·ªçn ${files.length} file`);
                    
                    // Update counts for batch mode
                    if (input.id === 'batchVoucherInput' || input.id === 'batchQrInput' || input.id === 'voucherListInput') {
                        this.updateFileCounts();
                    }
                    
                    // Show preview
                    this.showFilePreview(files, input.id);
                }
            },

            showFilePreview(files, inputId) {
                const previewSection = document.getElementById('previewSection');
                const previewGrid = document.getElementById('previewGrid');
                
                previewGrid.innerHTML = '';
                previewSection.style.display = 'block';

                const totalFiles = files.length;
                const PREVIEW_LIMIT = 20;
                let isExpanded = false;

                const renderPreviews = (limit) => {
                    previewGrid.innerHTML = '';
                    
                    const itemsToShow = limit || totalFiles;
                    
                    Array.from(files).slice(0, itemsToShow).forEach((file, index) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const previewItem = document.createElement('div');
                            previewItem.className = 'dvntAddIg__preview-item';
                            previewItem.innerHTML = `
                                <img src="${e.target.result}" alt="${file.name}" class="dvntAddIg__preview-image">
                                <p class="dvntAddIg__preview-name">${file.name}</p>
                            `;
                            previewGrid.appendChild(previewItem);
                        };
                        reader.readAsDataURL(file);
                    });

                    // Add expand/collapse button if needed
                    if (totalFiles > PREVIEW_LIMIT) {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 1rem;';
                        
                        if (!isExpanded) {
                            buttonContainer.innerHTML = `
                                <p style="color: var(--dvntAddIg-text-secondary); margin-bottom: 1rem;">
                                    ƒêang hi·ªÉn th·ªã ${PREVIEW_LIMIT}/${totalFiles} ·∫£nh
                                </p>
                                <button class="dvntAddIg__button dvntAddIg__button--secondary" id="expandPreviewBtn">
                                    <span>üëÅÔ∏è Xem th√™m ${totalFiles - PREVIEW_LIMIT} ·∫£nh</span>
                                </button>
                            `;
                        } else {
                            buttonContainer.innerHTML = `
                                <p style="color: var(--dvntAddIg-text-secondary); margin-bottom: 1rem;">
                                    ƒêang hi·ªÉn th·ªã t·∫•t c·∫£ ${totalFiles} ·∫£nh
                                </p>
                                <button class="dvntAddIg__button dvntAddIg__button--secondary" id="collapsePreviewBtn">
                                    <span>üîº Thu g·ªçn</span>
                                </button>
                            `;
                        }
                        
                        previewGrid.appendChild(buttonContainer);
                        
                        // Add event listener after DOM insertion
                        setTimeout(() => {
                            const expandBtn = document.getElementById('expandPreviewBtn');
                            const collapseBtn = document.getElementById('collapsePreviewBtn');
                            
                            if (expandBtn) {
                                expandBtn.addEventListener('click', () => {
                                    isExpanded = true;
                                    renderPreviews(totalFiles);
                                });
                            }
                            
                            if (collapseBtn) {
                                collapseBtn.addEventListener('click', () => {
                                    isExpanded = false;
                                    renderPreviews(PREVIEW_LIMIT);
                                    // Scroll back to preview section
                                    previewSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                                });
                            }
                        }, 100);
                    }
                };

                // Initial render with limit
                renderPreviews(totalFiles > PREVIEW_LIMIT ? PREVIEW_LIMIT : totalFiles);
            },

            // Helper: Calculate scale for canvas
            calculateScale(imageWidth) {
                return Math.min(CONSTANTS.MAX_CANVAS_WIDTH / imageWidth, 1);
            },

            // Calculate QR position
            calculateQRPosition(voucherWidth, voucherHeight, qrSize, position, customX = 0, customY = 0) {
                const margin = 20; // margin from edges
                let x = 0, y = 0;

                switch (position) {
                    case 'top-left':
                        x = margin;
                        y = margin;
                        break;
                    case 'top-right':
                        x = voucherWidth - qrSize - margin;
                        y = margin;
                        break;
                    case 'bottom-left':
                        x = margin;
                        y = voucherHeight - qrSize - margin;
                        break;
                    case 'bottom-right':
                        x = voucherWidth - qrSize - margin;
                        y = voucherHeight - qrSize - margin;
                        break;
                    case 'center':
                        x = (voucherWidth - qrSize) / 2;
                        y = (voucherHeight - qrSize) / 2;
                        break;
                    case 'custom':
                        x = customX;
                        y = customY;
                        break;
                }

                return { x, y };
            },

            // Merge QR code onto voucher
            mergeQRToVoucher(voucherImg, qrImg, position, sizePercent, customX = 0, customY = 0) {
                try {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Set canvas size to voucher size
                    canvas.width = voucherImg.width;
                    canvas.height = voucherImg.height;

                    // Draw voucher
                    ctx.drawImage(voucherImg, 0, 0);

                    // Calculate QR size
                    const qrSize = (voucherImg.width * sizePercent) / 100;

                    // Calculate position
                    const { x, y } = this.calculateQRPosition(
                        voucherImg.width,
                        voucherImg.height,
                        qrSize,
                        position,
                        customX,
                        customY
                    );

                    // Draw QR code
                    ctx.drawImage(qrImg, x, y, qrSize, qrSize);

                    // Apply filters if needed
                    const brightness = document.getElementById('brightness')?.value || CONSTANTS.DEFAULT_BRIGHTNESS;
                    const contrast = document.getElementById('contrast')?.value || CONSTANTS.DEFAULT_CONTRAST;
                    
                    if (brightness != CONSTANTS.DEFAULT_BRIGHTNESS || contrast != CONSTANTS.DEFAULT_CONTRAST) {
                        ctx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
                        ctx.drawImage(canvas, 0, 0);
                    }

                    return canvas;
                } catch (error) {
                    console.error('Error merging QR to voucher:', error);
                    throw new Error('Kh√¥ng th·ªÉ gh√©p QR v√†o voucher. Vui l√≤ng th·ª≠ l·∫°i!');
                }
            },

            // Download image
            downloadImage(canvas, filename) {
                try {
                    const format = document.getElementById('outputFormat')?.value || 'png';
                    const quality = (document.getElementById('outputQuality')?.value || CONSTANTS.DEFAULT_QUALITY) / 100;
                    const prefix = document.getElementById('filePrefix')?.value || 'voucher_qr_';

                    const link = document.createElement('a');
                    link.download = `${prefix}${filename}.${format}`;
                    link.href = canvas.toDataURL(`image/${format}`, quality);
                    link.click();
                    
                    // Cleanup
                    setTimeout(() => {
                        URL.revokeObjectURL(link.href);
                    }, 100);
                } catch (error) {
                    console.error('Error downloading image:', error);
                    alert('L·ªói khi t·∫£i ·∫£nh: ' + error.message);
                }
            },

            // Create interactive canvas with draggable QR
            createInteractiveCanvas(voucherImg, qrImg, index, sizePercent, position) {
                const container = document.createElement('div');
                container.style.textAlign = 'center';
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas size
                const scale = this.calculateScale(voucherImg.width);
                canvas.width = voucherImg.width * scale;
                canvas.height = voucherImg.height * scale;
                
                canvas.className = 'dvntAddIg__canvas';
                
                // Calculate QR size
                const qrSize = (canvas.width * sizePercent) / 100;
                
                // Calculate initial position
                const { x, y } = this.calculateQRPosition(
                    canvas.width,
                    canvas.height,
                    qrSize,
                    position
                );
                
                // Store position
                if (!this.qrPositions[index]) {
                    this.qrPositions[index] = { x, y, size: qrSize };
                }
                
                // Draw function
                const redraw = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(voucherImg, 0, 0, canvas.width, canvas.height);
                    ctx.drawImage(
                        qrImg,
                        this.qrPositions[index].x,
                        this.qrPositions[index].y,
                        this.qrPositions[index].size,
                        this.qrPositions[index].size
                    );
                };
                
                redraw();
                
                // Dragging
                let isDragging = false;
                let dragOffsetX = 0;
                let dragOffsetY = 0;
                
                canvas.addEventListener('mousedown', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const pos = this.qrPositions[index];
                    if (mouseX >= pos.x && mouseX <= pos.x + pos.size &&
                        mouseY >= pos.y && mouseY <= pos.y + pos.size) {
                        isDragging = true;
                        dragOffsetX = mouseX - pos.x;
                        dragOffsetY = mouseY - pos.y;
                        canvas.style.cursor = 'grabbing';
                    }
                });
                
                canvas.addEventListener('mousemove', (e) => {
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const pos = this.qrPositions[index];
                    
                    // Change cursor when hovering over QR
                    if (mouseX >= pos.x && mouseX <= pos.x + pos.size &&
                        mouseY >= pos.y && mouseY <= pos.y + pos.size) {
                        canvas.style.cursor = 'grab';
                    } else if (!isDragging) {
                        canvas.style.cursor = 'default';
                    }
                    
                    if (isDragging) {
                        pos.x = Math.max(0, Math.min(canvas.width - pos.size, mouseX - dragOffsetX));
                        pos.y = Math.max(0, Math.min(canvas.height - pos.size, mouseY - dragOffsetY));
                        
                        // Update sliders
                        const scale = this.calculateScale(voucherImg.width);
                        const actualX = Math.round(pos.x / scale);
                        const actualY = Math.round(pos.y / scale);
                        
                        const sliderX = document.getElementById(`batchSliderX${index}`);
                        const sliderY = document.getElementById(`batchSliderY${index}`);
                        if (sliderX && sliderY) {
                            sliderX.value = actualX;
                            sliderY.value = actualY;
                            document.getElementById(`batchX${index}`).textContent = actualX + 'px';
                            document.getElementById(`batchY${index}`).textContent = actualY + 'px';
                        }
                        
                        redraw();
                    }
                });
                
                canvas.addEventListener('mouseup', () => {
                    isDragging = false;
                    canvas.style.cursor = 'grab';
                });
                
                canvas.addEventListener('mouseleave', () => {
                    isDragging = false;
                    canvas.style.cursor = 'default';
                });
                
                // Touch support for mobile
                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const rect = canvas.getBoundingClientRect();
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    
                    const pos = this.qrPositions[index];
                    if (touchX >= pos.x && touchX <= pos.x + pos.size &&
                        touchY >= pos.y && touchY <= pos.y + pos.size) {
                        isDragging = true;
                        dragOffsetX = touchX - pos.x;
                        dragOffsetY = touchY - pos.y;
                    }
                });
                
                canvas.addEventListener('touchmove', (e) => {
                    if (isDragging) {
                        e.preventDefault();
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        const touchX = touch.clientX - rect.left;
                        const touchY = touch.clientY - rect.top;
                        
                        const pos = this.qrPositions[index];
                        pos.x = Math.max(0, Math.min(canvas.width - pos.size, touchX - dragOffsetX));
                        pos.y = Math.max(0, Math.min(canvas.height - pos.size, touchY - dragOffsetY));
                        redraw();
                    }
                });
                
                canvas.addEventListener('touchend', () => {
                    isDragging = false;
                });
                
                const filename = this.batchVouchers[index].name;
                container.innerHTML = `
               
                        <h4 style="color: var(--dvntAddIg-text-primary); margin-bottom: 0.5rem;">Voucher ${index + 1}</h4>
                        <p style="color: var(--dvntAddIg-text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">${filename}</p>
                    
                `;
                container.appendChild(canvas);
                
                // Add fine-tune controls for batch mode
                const batchFineTune = document.createElement('div');
                batchFineTune.style.cssText = 'margin-top: 1rem; padding: 1rem; background: var(--dvntAddIg-light-bg); border-radius: 8px;';
                batchFineTune.innerHTML = `
                    <div style="margin-bottom: 0.75rem;">
                        <label style="display: block; font-size: 0.85rem; color: var(--dvntAddIg-text-secondary); margin-bottom: 0.25rem;">
                            ‚ÜîÔ∏è Ngang: <strong id="batchX${index}" style="color: var(--dvntAddIg-primary-color);">0px</strong>
                        </label>
                        <input type="range" class="dvntAddIg__input" id="batchSliderX${index}" value="0" min="0" max="${this.batchVouchers[index].img.width}" step="1" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85rem; color: var(--dvntAddIg-text-secondary); margin-bottom: 0.25rem;">
                            ‚ÜïÔ∏è D·ªçc: <strong id="batchY${index}" style="color: var(--dvntAddIg-primary-color);">0px</strong>
                        </label>
                        <input type="range" class="dvntAddIg__input" id="batchSliderY${index}" value="0" min="0" max="${this.batchVouchers[index].img.height}" step="1" style="width: 100%;">
                    </div>
                `;
                container.appendChild(batchFineTune);
                
                // NOW get the sliders AFTER they're added to DOM
                setTimeout(() => {
                    const sliderX = document.getElementById(`batchSliderX${index}`);
                    const sliderY = document.getElementById(`batchSliderY${index}`);
                    
                    // Update initial values
                    const canvasScale = this.calculateScale(this.batchVouchers[index].img.width);
                    const initialX = Math.round(this.qrPositions[index].x / canvasScale);
                    const initialY = Math.round(this.qrPositions[index].y / canvasScale);
                    
                    if (sliderX && sliderY) {
                        sliderX.value = initialX;
                        sliderY.value = initialY;
                        document.getElementById(`batchX${index}`).textContent = initialX + 'px';
                        document.getElementById(`batchY${index}`).textContent = initialY + 'px';
                        
                        sliderX.addEventListener('input', () => {
                            const newX = parseInt(sliderX.value);
                            this.qrPositions[index].x = newX * canvasScale;
                            document.getElementById(`batchX${index}`).textContent = newX + 'px';
                            
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(this.batchVouchers[index].img, 0, 0, canvas.width, canvas.height);
                            ctx.drawImage(
                                this.batchQRs[index],
                                this.qrPositions[index].x,
                                this.qrPositions[index].y,
                                this.qrPositions[index].size,
                                this.qrPositions[index].size
                            );
                        });
                        
                        sliderY.addEventListener('input', () => {
                            const newY = parseInt(sliderY.value);
                            this.qrPositions[index].y = newY * canvasScale;
                            document.getElementById(`batchY${index}`).textContent = newY + 'px';
                            
                            const ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(this.batchVouchers[index].img, 0, 0, canvas.width, canvas.height);
                            ctx.drawImage(
                                this.batchQRs[index],
                                this.qrPositions[index].x,
                                this.qrPositions[index].y,
                                this.qrPositions[index].size,
                                this.qrPositions[index].size
                            );
                        });
                    }
                }, 0);
                
                // Add hint text
                const hintText = document.createElement('p');
                hintText.style.cssText = 'color: var(--dvntAddIg-text-secondary); font-size: 0.8rem; margin-top: 0.5rem; text-align: center; font-style: italic;';
                hintText.textContent = 'ÔøΩ ƒêi·ªÅu ch·ªânh ri√™ng voucher n√†y, ho·∫∑c d√πng thanh tr∆∞·ª£t chung ·ªü tr√™n';
                container.appendChild(hintText);
                
                return container;
            },

            // Generate QR code from pattern
            async generateQRFromPattern(index, pattern) {
                try {
                    const content = pattern.replace('{index}', index + 1);
                    
                    return new Promise((resolve, reject) => {
                        const container = document.createElement('div');
                        container.style.display = 'none';
                        document.body.appendChild(container);
                        
                        const qrDiv = document.createElement('div');
                        container.appendChild(qrDiv);
                        
                        try {
                            const qrcode = new QRCode(qrDiv, {
                                text: content,
                                width: CONSTANTS.QR_SIZE,
                                height: CONSTANTS.QR_SIZE,
                                colorDark: '#000000',
                                colorLight: '#ffffff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                            
                            setTimeout(() => {
                                const img = qrDiv.querySelector('img');
                                if (!img) {
                                    document.body.removeChild(container);
                                    reject(new Error('Kh√¥ng th·ªÉ t·∫°o QR code'));
                                    return;
                                }
                                
                                const qrImage = new Image();
                                qrImage.onload = () => {
                                    document.body.removeChild(container);
                                    resolve(qrImage);
                                };
                                qrImage.onerror = () => {
                                    document.body.removeChild(container);
                                    reject(new Error('L·ªói khi t·∫£i QR image'));
                                };
                                qrImage.src = img.src;
                            }, 100);
                        } catch (error) {
                            document.body.removeChild(container);
                            reject(error);
                        }
                    });
                } catch (error) {
                    console.error('Error generating QR code:', error);
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o m√£ QR: ' + error.message);
                }
            },

            // Batch processing
            initBatchProcessing() {
                const batchProcessBtn = document.getElementById('batchProcessBtn');
                const downloadAllBtn = document.getElementById('downloadAllBtn');
                const downloadZipBtn = document.getElementById('downloadZipBtn');
                const resetBtn = document.getElementById('resetBatchBtn');
                const batchPosition = document.getElementById('batchPosition');
                const batchSize = document.getElementById('batchSize');

                if (batchProcessBtn) {
                    batchProcessBtn.addEventListener('click', () => {
                        this.processBatch();
                    });
                }

                if (downloadAllBtn) {
                    downloadAllBtn.addEventListener('click', () => {
                        this.downloadAllProcessed();
                    });
                }

                if (downloadZipBtn) {
                    downloadZipBtn.addEventListener('click', () => {
                        this.downloadAsZip();
                    });
                }

                if (resetBtn) {
                    resetBtn.addEventListener('click', () => {
                        this.resetBatch();
                    });
                }

                // Auto update batch preview on settings change
                if (batchPosition) {
                    batchPosition.addEventListener('change', () => {
                        this.updateBatchPreviewIfExists();
                    });
                }

                if (batchSize) {
                    batchSize.addEventListener('input', () => {
                        // Update display value
                        const batchSizeValue = document.getElementById('batchSizeValue');
                        if (batchSizeValue) {
                            batchSizeValue.textContent = batchSize.value + '%';
                        }
                        this.updateBatchPreviewIfExists();
                    });
                }
            },

            updateBatchPreviewIfExists() {
                // Only update if preview already exists
                if (this.batchVouchers.length > 0 && this.batchQRs.length > 0 && 
                    document.getElementById('interactivePreviewSection').style.display !== 'none') {
                    
                    const position = document.getElementById('batchPosition').value;
                    const sizePercent = parseInt(document.getElementById('batchSize').value);
                    
                    // Recalculate positions for all items
                    this.batchVouchers.forEach((voucher, index) => {
                        const canvasContainer = document.getElementById('canvasGrid').children[index];
                        if (canvasContainer) {
                            const canvas = canvasContainer.querySelector('canvas');
                            if (canvas) {
                                const qrSize = (canvas.width * sizePercent) / 100;
                                const { x, y } = this.calculateQRPosition(
                                    canvas.width,
                                    canvas.height,
                                    qrSize,
                                    position
                                );
                                
                                // Update stored position
                                this.qrPositions[index] = { x, y, size: qrSize };
                                
                                // Redraw canvas
                                const ctx = canvas.getContext('2d');
                                ctx.clearRect(0, 0, canvas.width, canvas.height);
                                ctx.drawImage(voucher.img, 0, 0, canvas.width, canvas.height);
                                ctx.drawImage(
                                    this.batchQRs[index],
                                    x, y, qrSize, qrSize
                                );
                            }
                        }
                    });
                }
            },

            resetBatch() {
                // Cleanup canvases to prevent memory leaks
                const canvasGrid = document.getElementById('canvasGrid');
                const canvases = canvasGrid.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                });
                
                // Clear DOM
                canvasGrid.innerHTML = '';
                
                // Reset UI
                document.getElementById('interactivePreviewSection').style.display = 'none';
                document.getElementById('globalPositionControls').style.display = 'none';
                document.getElementById('downloadAllBtn').style.display = 'none';
                document.getElementById('downloadZipBtn').style.display = 'none';
                document.getElementById('resetBatchBtn').style.display = 'none';
                document.getElementById('batchProcessBtn').innerHTML = '<span>Xem Tr∆∞·ªõc & ƒêi·ªÅu Ch·ªânh</span>';
                
                // Clear data arrays
                this.canvasItems = [];
                this.qrPositions = [];
                this.processedImages = [];
                this.batchVouchers = [];
                this.batchQRs = [];
                
                console.log('‚úì ƒê√£ reset v√† cleanup memory');
            },

            async processBatch() {
                try {
                    const qrMode = document.getElementById('qrMode').value;
                    const voucherFiles = document.getElementById('batchVoucherInput').files;
                    const qrFiles = document.getElementById('batchQrInput').files;
                    const voucherListFile = document.getElementById('voucherListInput').files[0];
                    const qrPattern = document.getElementById('qrUrlPattern').value;

                // Validate based on mode
                if (qrMode === 'list') {
                    // Mode: 1 voucher + nhi·ªÅu QR
                    if (!voucherListFile) {
                        alert('Vui l√≤ng ch·ªçn 1 ·∫£nh voucher');
                        return;
                    }
                    if (qrFiles.length === 0) {
                        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 m√£ QR');
                        return;
                    }
                } else {
                    // Normal modes
                    if (voucherFiles.length === 0) {
                        alert('Vui l√≤ng t·∫£i l√™n √≠t nh·∫•t 1 ·∫£nh voucher');
                        return;
                    }

                    if (qrMode === 'single' && qrFiles.length === 0) {
                        alert('Vui l√≤ng ch·ªçn 1 m√£ QR');
                        return;
                    }

                    if (qrMode === 'multiple') {
                        if (qrFiles.length === 0) {
                            alert('Vui l√≤ng t·∫£i l√™n m√£ QR');
                            return;
                        }
                        if (qrFiles.length !== voucherFiles.length) {
                            alert(`S·ªë l∆∞·ª£ng QR (${qrFiles.length}) ph·∫£i b·∫±ng s·ªë voucher (${voucherFiles.length})`);
                            return;
                        }
                    }

                    if (qrMode === 'generate' && !qrPattern.trim()) {
                        alert('Vui l√≤ng nh·∫≠p m·∫´u URL cho QR code');
                        return;
                    }
                }

                const position = document.getElementById('batchPosition').value;
                const sizePercent = parseInt(document.getElementById('batchSize').value);

                const batchProcessBtn = document.getElementById('batchProcessBtn');
                batchProcessBtn.innerHTML = '<div class="dvntAddIg__loading"></div> <span>ƒêang t·∫£i ·∫£nh...</span>';
                batchProcessBtn.disabled = true;

                // Load vouchers and QRs based on mode
                this.batchVouchers = [];
                this.batchQRs = [];

                if (qrMode === 'list') {
                    // Load 1 voucher
                    const voucherImg = await this.loadImage(voucherListFile);
                    
                    // Load all QRs
                    batchProcessBtn.innerHTML = '<div class="dvntAddIg__loading"></div> <span>ƒêang t·∫£i QR codes...</span>';
                    for (let i = 0; i < qrFiles.length; i++) {
                        const qrImg = await this.loadImage(qrFiles[i]);
                        this.batchQRs.push(qrImg);
                        // Create multiple instances of the same voucher
                        this.batchVouchers.push({ 
                            img: voucherImg, 
                            name: `${voucherListFile.name.replace(/\.[^/.]+$/, '')}_qr${i + 1}` 
                        });
                    }
                } else {
                    // Load all vouchers (normal mode)
                    for (let i = 0; i < voucherFiles.length; i++) {
                        const img = await this.loadImage(voucherFiles[i]);
                        this.batchVouchers.push({ img, name: voucherFiles[i].name.replace(/\.[^/.]+$/, '') });
                    }

                    // Load or generate QRs
                    if (qrMode === 'single') {
                        const qrImg = await this.loadImage(qrFiles[0]);
                        for (let i = 0; i < voucherFiles.length; i++) {
                            this.batchQRs.push(qrImg);
                        }
                    } else if (qrMode === 'multiple') {
                        for (let i = 0; i < qrFiles.length; i++) {
                            const qrImg = await this.loadImage(qrFiles[i]);
                            this.batchQRs.push(qrImg);
                        }
                    } else if (qrMode === 'generate') {
                        batchProcessBtn.innerHTML = '<div class="dvntAddIg__loading"></div> <span>ƒêang t·∫°o QR code...</span>';
                        for (let i = 0; i < voucherFiles.length; i++) {
                            const qrImg = await this.generateQRFromPattern(i, qrPattern);
                            this.batchQRs.push(qrImg);
                        }
                    }
                }

                    // Performance optimization for large batches
                    const totalItems = this.batchVouchers.length;
                    let currentPreviewLimit = CONSTANTS.INITIAL_PREVIEW_LIMIT;

                    // Create interactive preview (limited for large batches)
                    const canvasGrid = document.getElementById('canvasGrid');
                    canvasGrid.innerHTML = '';
                    this.qrPositions = [];

                    // Initialize QR positions for ALL items (not just preview)
                    for (let i = 0; i < totalItems; i++) {
                        const canvas = document.createElement('canvas');
                        const scale = this.calculateScale(this.batchVouchers[i].img.width);
                        canvas.width = this.batchVouchers[i].img.width * scale;
                        canvas.height = this.batchVouchers[i].img.height * scale;
                        
                        const qrSize = (canvas.width * sizePercent) / 100;
                        const { x, y } = this.calculateQRPosition(canvas.width, canvas.height, qrSize, position);
                        
                        this.qrPositions.push({ x, y, size: qrSize });
                    }

                // Function to render previews with progressive loading
                const renderPreviews = (limit) => {
                    // Clear only the canvas items, keep the warning if exists
                    const existingCanvases = canvasGrid.querySelectorAll('.dvntAddIg__canvas');
                    existingCanvases.forEach(canvas => {
                        canvas.parentElement.remove();
                    });
                    
                    // Remove existing buttons
                    const existingButtons = canvasGrid.querySelector('#previewButtonContainer');
                    if (existingButtons) existingButtons.remove();

                    // Create preview items
                    const itemsToShow = Math.min(limit, totalItems);
                    for (let i = 0; i < itemsToShow; i++) {
                        const canvasContainer = this.createInteractiveCanvas(
                            this.batchVouchers[i].img,
                            this.batchQRs[i],
                            i,
                            sizePercent,
                            position
                        );
                        canvasGrid.appendChild(canvasContainer);
                    }

                    // Add control buttons if needed
                    if (totalItems > CONSTANTS.INITIAL_PREVIEW_LIMIT) {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.id = 'previewButtonContainer';
                        buttonContainer.style.cssText = 'grid-column: 1 / -1; text-align: center; padding: 2rem; background: var(--dvntAddIg-light-bg); border-radius: 8px; margin-top: 1rem;';
                        
                        let buttonsHTML = `
                            <p style="color: var(--dvntAddIg-text-secondary); margin-bottom: 1rem; font-weight: 600;">
                                üìä ƒêang hi·ªÉn th·ªã ${itemsToShow}/${totalItems} voucher
                            </p>
                        `;

                        // Show "Xem th√™m" button if not showing all
                        if (itemsToShow < totalItems) {
                            const nextLimit = Math.min(limit * 2, totalItems);
                            const moreItems = nextLimit - itemsToShow;
                            buttonsHTML += `
                                <button class="dvntAddIg__button dvntAddIg__button--primary" id="loadMorePreview" style="margin-right: 0.5rem;">
                                    <span>üëÅÔ∏è Xem th√™m ${moreItems} ·∫£nh (${nextLimit}/${totalItems})</span>
                                </button>
                            `;
                        }

                        // Show "Thu g·ªçn" button if showing more than initial
                        if (itemsToShow > CONSTANTS.INITIAL_PREVIEW_LIMIT) {
                            buttonsHTML += `
                                <button class="dvntAddIg__button dvntAddIg__button--secondary" id="collapsePreview" style="margin-right: 0.5rem;">
                                    <span>üîº Thu g·ªçn v·ªÅ ${CONSTANTS.INITIAL_PREVIEW_LIMIT} ·∫£nh</span>
                                </button>
                            `;
                        }

                        // Show "Skip to download" button for large batches
                        if (totalItems > 20) {
                            buttonsHTML += `
                                <button class="dvntAddIg__button dvntAddIg__button--secondary" id="skipToDownload">
                                    <span>‚ö° B·ªè qua xem tr∆∞·ªõc, t·∫£i xu·ªëng ngay ${totalItems} ·∫£nh</span>
                                </button>
                            `;
                        }

                        buttonContainer.innerHTML = buttonsHTML;
                        canvasGrid.appendChild(buttonContainer);

                        // Add event listeners
                        setTimeout(() => {
                            const loadMoreBtn = document.getElementById('loadMorePreview');
                            const collapseBtn = document.getElementById('collapsePreview');
                            const skipBtn = document.getElementById('skipToDownload');

                            if (loadMoreBtn) {
                                loadMoreBtn.addEventListener('click', () => {
                                    currentPreviewLimit = Math.min(limit * 2, totalItems);
                                    renderPreviews(currentPreviewLimit);
                                    // Scroll to new items
                                    setTimeout(() => {
                                        const canvases = canvasGrid.querySelectorAll('.dvntAddIg__canvas');
                                        if (canvases[limit]) {
                                            canvases[limit].scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }
                                    }, 100);
                                });
                            }

                            if (collapseBtn) {
                                collapseBtn.addEventListener('click', () => {
                                    currentPreviewLimit = CONSTANTS.INITIAL_PREVIEW_LIMIT;
                                    renderPreviews(currentPreviewLimit);
                                    // Scroll to top
                                    document.getElementById('interactivePreviewSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
                                });
                            }

                            if (skipBtn) {
                                skipBtn.addEventListener('click', () => {
                                    this.downloadAllProcessed();
                                });
                            }
                        }, 100);
                    }
                };

                    // Initial render
                    renderPreviews(currentPreviewLimit);

                    document.getElementById('interactivePreviewSection').style.display = 'block';
                    document.getElementById('globalPositionControls').style.display = 'block';
                    document.getElementById('downloadAllBtn').style.display = 'inline-flex';
                    
                    // Show ZIP button only if there are 2 or more images
                    if (totalItems >= 2) {
                        document.getElementById('downloadZipBtn').style.display = 'inline-flex';
                    }
                    
                    document.getElementById('resetBatchBtn').style.display = 'inline-flex';
                    
                    batchProcessBtn.innerHTML = `<span>‚úì ƒê√£ t·∫°o xem tr∆∞·ªõc (${Math.min(currentPreviewLimit, totalItems)}/${totalItems})</span>`;
                    batchProcessBtn.disabled = false;

                    // Initialize global sliders
                    this.initGlobalSliders();

                    // Scroll to preview
                    document.getElementById('interactivePreviewSection').scrollIntoView({ behavior: 'smooth' });
                    
                } catch (error) {
                    console.error('Error processing batch:', error);
                    alert('L·ªói khi x·ª≠ l√Ω batch: ' + error.message);
                    
                    const batchProcessBtn = document.getElementById('batchProcessBtn');
                    batchProcessBtn.innerHTML = '<span>‚ùå L·ªói - Th·ª≠ l·∫°i</span>';
                    batchProcessBtn.disabled = false;
                }
            },

            // Initialize global sliders to control all vouchers at once
            initGlobalSliders() {
                const globalSliderX = document.getElementById('globalSliderX');
                const globalSliderY = document.getElementById('globalSliderY');
                const globalXValue = document.getElementById('globalXValue');
                const globalYValue = document.getElementById('globalYValue');

                if (!globalSliderX || !globalSliderY) return;

                // Find max dimensions from all vouchers
                let maxWidth = 0;
                let maxHeight = 0;
                this.batchVouchers.forEach(v => {
                    if (v.img.width > maxWidth) maxWidth = v.img.width;
                    if (v.img.height > maxHeight) maxHeight = v.img.height;
                });

                globalSliderX.max = maxWidth;
                globalSliderY.max = maxHeight;

                // Set initial values from first voucher
                if (this.qrPositions.length > 0) {
                    const scale = this.calculateScale(this.batchVouchers[0].img.width);
                    const initialX = Math.round(this.qrPositions[0].x / scale);
                    const initialY = Math.round(this.qrPositions[0].y / scale);
                    
                    globalSliderX.value = initialX;
                    globalSliderY.value = initialY;
                    globalXValue.textContent = initialX + 'px';
                    globalYValue.textContent = initialY + 'px';
                }

                // Debounce function for better performance
                let debounceTimeout;
                const debounce = (func, delay = CONSTANTS.DEBOUNCE_DELAY) => {
                    return (...args) => {
                        clearTimeout(debounceTimeout);
                        debounceTimeout = setTimeout(() => func(...args), delay);
                    };
                };

                // Handle X slider with debounce for large batches
                const updateXPosition = (newX) => {
                    // Update all positions immediately
                    this.batchVouchers.forEach((voucher, index) => {
                        const scale = this.calculateScale(voucher.img.width);
                        this.qrPositions[index].x = newX * scale;

                        // Update individual slider if exists (only for previewed items)
                        const sliderX = document.getElementById(`batchSliderX${index}`);
                        if (sliderX) {
                            sliderX.value = newX;
                            const displayX = document.getElementById(`batchX${index}`);
                            if (displayX) displayX.textContent = newX + 'px';
                        }
                    });

                    // Redraw only visible canvases (performance optimization)
                    const canvasGrid = document.getElementById('canvasGrid');
                    const visibleCanvases = canvasGrid.querySelectorAll('canvas');
                    visibleCanvases.forEach((canvas, idx) => {
                        this.redrawBatchCanvas(idx);
                    });
                };

                globalSliderX.addEventListener('input', () => {
                    const newX = parseInt(globalSliderX.value);
                    globalXValue.textContent = newX + 'px';
                    
                    // Use debounce only for large batches
                    if (this.batchVouchers.length > CONSTANTS.LAG_WARNING_THRESHOLD) {
                        debounce(updateXPosition, CONSTANTS.DEBOUNCE_DELAY)(newX);
                    } else {
                        updateXPosition(newX);
                    }
                });

                // Handle Y slider with debounce
                const updateYPosition = (newY) => {
                    // Update all positions immediately
                    this.batchVouchers.forEach((voucher, index) => {
                        const scale = this.calculateScale(voucher.img.width);
                        this.qrPositions[index].y = newY * scale;

                        // Update individual slider if exists (only for previewed items)
                        const sliderY = document.getElementById(`batchSliderY${index}`);
                        if (sliderY) {
                            sliderY.value = newY;
                            const displayY = document.getElementById(`batchY${index}`);
                            if (displayY) displayY.textContent = newY + 'px';
                        }
                    });

                    // Redraw only visible canvases
                    const canvasGrid = document.getElementById('canvasGrid');
                    const visibleCanvases = canvasGrid.querySelectorAll('canvas');
                    visibleCanvases.forEach((canvas, idx) => {
                        this.redrawBatchCanvas(idx);
                    });
                };

                globalSliderY.addEventListener('input', () => {
                    const newY = parseInt(globalSliderY.value);
                    globalYValue.textContent = newY + 'px';
                    
                    // Use debounce only for large batches
                    if (this.batchVouchers.length > CONSTANTS.LAG_WARNING_THRESHOLD) {
                        debounce(updateYPosition, CONSTANTS.DEBOUNCE_DELAY)(newY);
                    } else {
                        updateYPosition(newY);
                    }
                });
            },

            // Helper function to redraw a specific batch canvas
            redrawBatchCanvas(index) {
                const canvasGrid = document.getElementById('canvasGrid');
                const canvasContainer = canvasGrid.children[index];
                if (!canvasContainer) return;

                const canvas = canvasContainer.querySelector('canvas');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                const scale = this.calculateScale(this.batchVouchers[index].img.width);

                // Apply brightness and contrast filters
                const brightness = document.getElementById('brightness')?.value || CONSTANTS.DEFAULT_BRIGHTNESS;
                const contrast = document.getElementById('contrast')?.value || CONSTANTS.DEFAULT_CONTRAST;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Apply filter before drawing
                if (brightness != CONSTANTS.DEFAULT_BRIGHTNESS || contrast != CONSTANTS.DEFAULT_CONTRAST) {
                    ctx.filter = `brightness(${brightness}%) contrast(${contrast}%)`;
                }
                
                ctx.drawImage(this.batchVouchers[index].img, 0, 0, canvas.width, canvas.height);
                
                // Reset filter for QR
                ctx.filter = 'none';
                
                ctx.drawImage(
                    this.batchQRs[index],
                    this.qrPositions[index].x,
                    this.qrPositions[index].y,
                    this.qrPositions[index].size,
                    this.qrPositions[index].size
                );
            },

            loadImage(file) {
                return new Promise((resolve, reject) => {
                    try {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const img = new Image();
                            img.onload = () => resolve(img);
                            img.onerror = () => reject(new Error(`Kh√¥ng th·ªÉ t·∫£i ·∫£nh: ${file.name}`));
                            img.src = e.target.result;
                        };
                        reader.onerror = () => reject(new Error(`L·ªói ƒë·ªçc file: ${file.name}`));
                        reader.readAsDataURL(file);
                    } catch (error) {
                        reject(new Error(`L·ªói khi x·ª≠ l√Ω file: ${error.message}`));
                    }
                });
            },

            downloadAllProcessed() {
                const total = this.batchVouchers.length;
                
                // Show warning for large batches
                if (total > CONSTANTS.LAG_WARNING_THRESHOLD) {
                    const confirmed = confirm(
                        `‚ö†Ô∏è C·∫¢NH B√ÅO LAG!\n\n` +
                        `B·∫°n ƒëang chu·∫©n b·ªã t·∫£i ${total} ·∫£nh ri√™ng l·∫ª.\n` +
                        `Tr√¨nh duy·ªát c√≥ th·ªÉ b·ªã lag ho·∫∑c ch·∫≠m trong qu√° tr√¨nh t·∫£i.\n\n` +
                        `üí° KHUY·∫æN NGH·ªä: S·ª≠ d·ª•ng n√∫t "üì¶ T·∫£i N√©n ZIP" s·∫Ω nhanh v√† ti·ªán h∆°n!\n\n` +
                        `B·∫°n c√≥ ch·∫Øc mu·ªën ti·∫øp t·ª•c t·∫£i t·ª´ng t·∫•m kh√¥ng?`
                    );
                    
                    if (!confirmed) {
                        // User cancelled, suggest ZIP download
                        const useZip = confirm(
                            `B·∫°n c√≥ mu·ªën t·∫£i d∆∞·ªõi d·∫°ng file ZIP thay v√†o kh√¥ng?\n` +
                            `(Nhanh h∆°n v√† d·ªÖ qu·∫£n l√Ω h∆°n)`
                        );
                        
                        if (useZip) {
                            this.downloadAsZip();
                        }
                        return;
                    }
                }

                const progressBar = document.getElementById('batchProgress');
                const progressFill = document.getElementById('batchProgressBar');
                progressBar.style.display = 'block';

                const downloadBtn = document.getElementById('downloadAllBtn');
                downloadBtn.innerHTML = '<div class="dvntAddIg__loading"></div> <span>ƒêang xu·∫•t ·∫£nh...</span>';
                downloadBtn.disabled = true;
                let completed = 0;

                // Optimized batch processing - adjust delay based on total count
                const isLargeBatch = total > CONSTANTS.LARGE_BATCH_THRESHOLD;
                const BATCH_SIZE = isLargeBatch ? CONSTANTS.LARGE_BATCH_SIZE : CONSTANTS.SMALL_BATCH_SIZE;
                const DELAY_BETWEEN_BATCHES = isLargeBatch ? CONSTANTS.LARGE_BATCH_DELAY : CONSTANTS.SMALL_BATCH_DELAY;
                const DELAY_BETWEEN_FILES = isLargeBatch ? CONSTANTS.LARGE_FILE_DELAY : CONSTANTS.SMALL_FILE_DELAY;

                const processBatch = (startIndex) => {
                    const endIndex = Math.min(startIndex + BATCH_SIZE, total);
                    
                    for (let i = startIndex; i < endIndex; i++) {
                        ((index) => {
                            setTimeout(() => {
                                try {
                                    const voucher = this.batchVouchers[index];
                                    const canvas = document.createElement('canvas');
                                    const ctx = canvas.getContext('2d');
                                    
                                    // Use original image size
                                    canvas.width = voucher.img.width;
                                    canvas.height = voucher.img.height;
                                    
                                    // Draw voucher
                                    ctx.drawImage(voucher.img, 0, 0);
                                    
                                    // Calculate scale
                                    const scale = this.calculateScale(voucher.img.width);
                                
                                    // Draw QR with adjusted position
                                    const pos = this.qrPositions[index];
                                    const actualX = pos.x / scale;
                                    const actualY = pos.y / scale;
                                    const actualSize = pos.size / scale;
                                    
                                    ctx.drawImage(
                                        this.batchQRs[index],
                                        actualX,
                                        actualY,
                                        actualSize,
                                        actualSize
                                    );
                                    
                                    this.downloadImage(canvas, voucher.name);
                                    
                                    completed++;
                                    progressFill.style.width = `${(completed / total) * 100}%`;
                                    
                                    // Update button text with progress
                                    downloadBtn.innerHTML = `<div class="dvntAddIg__loading"></div> <span>ƒêang xu·∫•t ${completed}/${total}...</span>`;
                                    
                                    if (completed === total) {
                                    setTimeout(() => {
                                        progressBar.style.display = 'none';
                                        downloadBtn.innerHTML = '<span>‚úì ƒê√£ t·∫£i t·∫•t c·∫£</span>';
                                        downloadBtn.disabled = false;
                                        
                                        // Show success notification
                                        const notification = document.createElement('div');
                                        notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #10b981; color: white; padding: 2rem 3rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 9999; font-size: 1.2rem; font-weight: 600;';
                                        notification.textContent = `‚úì ƒê√£ t·∫£i xu·ªëng th√†nh c√¥ng ${total} voucher!`;
                                        document.body.appendChild(notification);
                                        
                                        setTimeout(() => {
                                            notification.remove();
                                        }, 3000);
                                    }, 500);
                                    }
                                } catch (error) {
                                    console.error(`Error processing voucher ${index}:`, error);
                                    completed++;
                                    progressFill.style.width = `${(completed / total) * 100}%`;
                                }
                            }, (i - startIndex) * DELAY_BETWEEN_FILES);
                        })(i);
                    }
                    
                    // Process next batch
                    if (endIndex < total) {
                        setTimeout(() => {
                            processBatch(endIndex);
                        }, BATCH_SIZE * DELAY_BETWEEN_FILES + DELAY_BETWEEN_BATCHES);
                    }
                };

                // Start processing
                processBatch(0);
            },

            // Download all images as ZIP file
            async downloadAsZip() {
                if (typeof JSZip === 'undefined') {
                    alert('Th∆∞ vi·ªán JSZip ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i!');
                    return;
                }

                const progressBar = document.getElementById('batchProgress');
                const progressFill = document.getElementById('batchProgressBar');
                progressBar.style.display = 'block';

                const downloadZipBtn = document.getElementById('downloadZipBtn');
                const originalHTML = downloadZipBtn.innerHTML;
                downloadZipBtn.innerHTML = '<div class="dvntAddIg__loading"></div> <span>ƒêang t·∫°o ZIP...</span>';
                downloadZipBtn.disabled = true;

                const total = this.batchVouchers.length;
                const zip = new JSZip();
                const format = document.getElementById('outputFormat')?.value || 'png';

                try {
                    // Process all images and add to ZIP
                    for (let index = 0; index < total; index++) {
                        const voucher = this.batchVouchers[index];
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // Use original image size
                        canvas.width = voucher.img.width;
                        canvas.height = voucher.img.height;
                        
                        // Draw voucher
                        ctx.drawImage(voucher.img, 0, 0);
                        
                        // Calculate scale
                        const scale = this.calculateScale(voucher.img.width);
                        
                        // Draw QR with adjusted position
                        const pos = this.qrPositions[index];
                        const actualX = pos.x / scale;
                        const actualY = pos.y / scale;
                        const actualSize = pos.size / scale;
                        
                        ctx.drawImage(
                            this.batchQRs[index],
                            actualX,
                            actualY,
                            actualSize,
                            actualSize
                        );
                        
                        // Convert canvas to blob
                        const quality = (document.getElementById('outputQuality')?.value || 95) / 100;
                        const blob = await new Promise(resolve => {
                            canvas.toBlob(resolve, `image/${format}`, quality);
                        });
                        
                        // Add to ZIP with filename
                        const prefix = document.getElementById('filePrefix')?.value || 'voucher_qr_';
                        const filename = `${prefix}${voucher.name}.${format}`;
                        zip.file(filename, blob);
                        
                        // Update progress
                        progressFill.style.width = `${((index + 1) / total) * 100}%`;
                        downloadZipBtn.innerHTML = `<div class="dvntAddIg__loading"></div> <span>ƒêang x·ª≠ l√Ω ${index + 1}/${total}...</span>`;
                    }

                    // Generate ZIP file
                    downloadZipBtn.innerHTML = '<div class="dvntAddIg__loading"></div> <span>ƒêang n√©n file...</span>';
                    const zipBlob = await zip.generateAsync({
                        type: 'blob',
                        compression: 'DEFLATE',
                        compressionOptions: { level: 6 }
                    }, (metadata) => {
                        // Update progress during compression
                        progressFill.style.width = `${metadata.percent}%`;
                    });

                    // Download ZIP file
                    const link = document.createElement('a');
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                    link.download = `vouchers_qr_${timestamp}.zip`;
                    link.href = URL.createObjectURL(zipBlob);
                    link.click();
                    URL.revokeObjectURL(link.href);

                    // Success
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                        downloadZipBtn.innerHTML = originalHTML;
                        downloadZipBtn.disabled = false;
                        
                        // Show success notification
                        const notification = document.createElement('div');
                        notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #10b981; color: white; padding: 2rem 3rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 9999; font-size: 1.2rem; font-weight: 600;';
                        notification.innerHTML = `
                            <div class="hi" style="text-align: center;">
                                <div style="font-size: 3rem; margin-bottom: 0.5rem;">üì¶</div>
                                <div>ƒê√£ t·∫°o file ZIP th√†nh c√¥ng!</div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem; opacity: 0.9;">${total} ·∫£nh ƒë√£ ƒë∆∞·ª£c n√©n</div>
                            </div>
                        `;
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.remove();
                        }, 3000);
                    }, 500);

                } catch (error) {
                    console.error('Error creating ZIP:', error);
                    alert('L·ªói khi t·∫°o file ZIP: ' + error.message);
                    progressBar.style.display = 'none';
                    downloadZipBtn.innerHTML = originalHTML;
                    downloadZipBtn.disabled = false;
                }
            },

            // Initialize all features
            init() {
                this.initTabs();
                this.initQRModeHandler();
                this.initUploadAreas();
                this.initBatchProcessing();
                this.initSettingsHandlers();
                console.log('DVNT QR Tools initialized successfully!');
            },

            // Settings handlers
            initSettingsHandlers() {
                const brightnessInput = document.getElementById('brightness');
                const contrastInput = document.getElementById('contrast');
                const outputQualityInput = document.getElementById('outputQuality');
                const outputFormat = document.getElementById('outputFormat');
                const filePrefix = document.getElementById('filePrefix');

                // Brightness control
                if (brightnessInput) {
                    brightnessInput.addEventListener('input', () => {
                        const brightnessValue = document.getElementById('brightnessValue');
                        if (brightnessValue) {
                            brightnessValue.textContent = brightnessInput.value + '%';
                        }
                        // Auto-apply to batch preview if exists
                        this.updateBatchPreviewIfExists();
                    });
                }

                // Contrast control
                if (contrastInput) {
                    contrastInput.addEventListener('input', () => {
                        const contrastValue = document.getElementById('contrastValue');
                        if (contrastValue) {
                            contrastValue.textContent = contrastInput.value + '%';
                        }
                        // Auto-apply to batch preview if exists
                        this.updateBatchPreviewIfExists();
                    });
                }

                // Output quality control
                if (outputQualityInput) {
                    outputQualityInput.addEventListener('input', () => {
                        const outputQualityValue = document.getElementById('outputQualityValue');
                        if (outputQualityValue) {
                            outputQualityValue.textContent = outputQualityInput.value + '%';
                        }
                        // Quality only affects download, show notification
                        this.showSettingUpdateNotification('Ch·∫•t l∆∞·ª£ng xu·∫•t ƒë√£ c·∫≠p nh·∫≠t');
                    });
                }

                // Output format control
                if (outputFormat) {
                    outputFormat.addEventListener('change', () => {
                        const format = outputFormat.value.toUpperCase();
                        this.showSettingUpdateNotification(`ƒê·ªãnh d·∫°ng xu·∫•t: ${format}`);
                    });
                }

                // File prefix control
                if (filePrefix) {
                    filePrefix.addEventListener('input', () => {
                        this.showSettingUpdateNotification('Ti·ªÅn t·ªë t√™n file ƒë√£ c·∫≠p nh·∫≠t');
                    });
                }
            },

            // Show temporary notification for settings update
            showSettingUpdateNotification(message) {
                // Remove existing notification if any
                const existing = document.getElementById('settingNotification');
                if (existing) existing.remove();

                const notification = document.createElement('div');
                notification.id = 'settingNotification';
                notification.style.cssText = `
                    position: fixed;
                    bottom: 2rem;
                    right: 2rem;
                    background: linear-gradient(135deg, #6366f1, #8b5cf6);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    z-index: 9999;
                    font-size: 0.9rem;
                    font-weight: 500;
                    opacity: 0;
                    transform: translateY(20px);
                    transition: all 0.3s ease;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>‚úì</span>
                        <span>${message}</span>
                    </div>
                `;
                document.body.appendChild(notification);

                // Animate in
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateY(0)';
                }, 10);

                // Animate out and remove
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateY(20px)';
                    setTimeout(() => notification.remove(), 300);
                }, 2000);
            }
        };

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            dvntAddIg.init();
        });
    </script>
</body>
</html>
